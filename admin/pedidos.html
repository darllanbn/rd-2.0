<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Pedidos | RD Distribuidora</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- QZ Tray -->
<script src="https://cdn.jsdelivr.net/npm/qz-tray@2.2.5/qz-tray.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  padding:20px;
}
.container {
  max-width:1100px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}
h1 {
  color:#ff7a00;
}
table {
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th, td {
  padding:10px;
  border-bottom:1px solid #ddd;
  text-align:center;
}
th {
  background:#ff7a00;
  color:#fff;
}
button {
  padding:6px 10px;
  border:none;
  border-radius:4px;
  cursor:pointer;
  font-size:14px;
}
.imprimir {
  background:#198754;
  color:#fff;
}
.imprimir:hover {
  background:#157347;
}
.impresso {
  background:#adb5bd;
  color:#333;
  cursor:not-allowed;
}
.voltar {
  background:#6c757d;
  color:#fff;
  margin-bottom:10px;
}
.voltar:hover {
  background:#5a6268;
}

/* Mobile */
@media (max-width:768px){
  table, thead, tbody, th, td, tr {
    display:block;
  }
  thead {
    display:none;
  }
  tr {
    border:1px solid #ddd;
    border-radius:6px;
    margin-bottom:10px;
    padding:10px;
  }
  td {
    border:none;
    text-align:left;
    padding:6px 0;
  }
  td::before {
    font-weight:bold;
    display:block;
  }
  td:nth-child(1)::before { content:"Pedido"; }
  td:nth-child(2)::before { content:"Data"; }
  td:nth-child(3)::before { content:"Condom√≠nio"; }
  td:nth-child(4)::before { content:"Casa"; }
  td:nth-child(5)::before { content:"Pagamento"; }
  td:nth-child(6)::before { content:"Total"; }
}
</style>
</head>

<body>

<div class="container">
  <button class="voltar" onclick="location.href='/admin/admin.html'">‚¨Ö Voltar</button>
  <h1>üìã Pedidos Recebidos</h1>

  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Data</th>
        <th>Condom√≠nio</th>
        <th>Casa</th>
        <th>Pagamento</th>
        <th>Total</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="lista"></tbody>
  </table>
</div>

<script>
const NOME_IMPRESSORA = "ELGIN i9 (USB)";

/* =========================
   CONECTAR AO QZ TRAY
========================= */
async function conectarQZ() {
  if (qz.websocket.isActive()) return;

  try {
    await qz.websocket.connect();
    console.log("‚úÖ QZ Tray conectado");
  } catch (err) {
    alert("‚ùå QZ Tray n√£o est√° aberto");
    throw err;
  }
}

/* =========================
   CARREGAR PEDIDOS
========================= */
async function carregarPedidos() {
  const res = await fetch('/admin/pedidos');
  const pedidos = await res.json();
  const tbody = document.getElementById('lista');
  tbody.innerHTML = '';

  if (!pedidos.length) {
    tbody.innerHTML = `<tr><td colspan="7">Nenhum pedido encontrado</td></tr>`;
    return;
  }

  pedidos.forEach(p => {
    const impresso = p.status === 'IMPRESSO';

    tbody.innerHTML += `
      <tr>
        <td>${p.id}</td>
        <td>${p.data}</td>
        <td>${p.condominio}</td>
        <td>${p.casa || '-'}</td>
        <td>${p.pagamento}</td>
        <td>R$ ${Number(p.total).toFixed(2)}</td>
        <td>
          ${
            impresso
              ? `<button class="impresso" disabled>‚úî IMPRESSO</button>`
              : `<button class="imprimir" onclick="imprimirPedido(${p.id})">üñ®Ô∏è Imprimir</button>`
          }
        </td>
      </tr>
    `;
  });
}

/* =========================
   IMPRIMIR PEDIDO
========================= */
async function imprimirPedido(id) {
  if (!confirm("Deseja imprimir este pedido?")) return;

  try {
    await conectarQZ();

    // Busca texto do pedido no servidor
    const res = await fetch(`/admin/pedidos/${id}/texto`);
    const texto = await res.text();

    const config = qz.configs.create(NOME_IMPRESSORA, {
      encoding: "ISO-8859-1",
      size: { width: 80, unit: "mm" }
    });

    const dados = [{
      type: 'raw',
      format: 'command',
      data: texto + "\n\n\n\n"
    }];

    await qz.print(config, dados);

    // Marca como impresso no banco
    await fetch(`/admin/pedidos/${id}/imprimir`, { method: 'POST' });

    alert("‚úÖ Pedido impresso com sucesso!");
    carregarPedidos();

  } catch (err) {
    console.error(err);
    alert("‚ùå Erro ao imprimir. Verifique o QZ Tray.");
  }
}

carregarPedidos();
</script>

</body>
</html>
